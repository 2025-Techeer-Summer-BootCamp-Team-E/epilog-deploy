name: TeamE CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: ğŸš€ ì„œë¹„ìŠ¤ ë°°í¬
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¢ ë°°í¬ ì‹œì‘ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ğŸš€ TeamE ë°°í¬ ì‹œì‘",
              attachments: [{
                color: "warning",
                fields: [{
                  title: "í™˜ê²½",
                  value: "${{ github.event.inputs.environment || 'production' }}",
                  short: true
                }, {
                  title: "ë¸Œëœì¹˜",
                  value: "${{ github.ref_name }}",
                  short: true
                }, {
                  title: "ì»¤ë°‹",
                  value: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                  short: true
                }, {
                  title: "ì‹¤í–‰ì",
                  value: "${{ github.actor }}",
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ” ë°°í¬ ì „ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ íŒŒì¼ ê²€ì¦ ì¤‘..."
          if [ ! -f "docker-compose.yml" ]; then
            echo "âŒ docker-compose.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… docker-compose.yml íŒŒì¼ í™•ì¸ë¨"

          # docker-compose íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬
          if ! grep -q "services:" docker-compose.yml; then
            echo "âŒ docker-compose.yml íŒŒì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… docker-compose.yml íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ ì™„ë£Œ"

      - name: ğŸ“¤ ë°°í¬ íŒŒì¼ ì„œë²„ ì „ì†¡
        id: copy
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "docker-compose.yml"
          target: /home/${{ secrets.SSH_USERNAME }}/epilog-deploy/
          strip_components: 0

      - name: ğŸ¯ ì„œë²„ ë°°í¬ ì‹¤í–‰
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            echo "ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
            cd /home/${{ secrets.SSH_USERNAME }}/epilog-deploy

            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—…
            echo "ğŸ’¾ í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—… ì¤‘..."
            mkdir -p backups
            docker compose ps > backups/services_backup_$(date +%Y%m%d_%H%M%S).txt || echo "ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—… ìƒëµ"

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
            docker compose down --remove-orphans

            # ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker compose pull

            # ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘
            echo "ğŸš€ ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker compose up -d

            # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 30

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ©º ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            max_attempts=20
            attempt=1

            while [ $attempt -le $max_attempts ]; do
              if docker compose ps | grep -q "Up"; then
                echo "âœ… ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. (ì‹œë„: $attempt/$max_attempts)"
                
                # ì¶”ê°€ í—¬ìŠ¤ì²´í¬ (í¬íŠ¸ í™•ì¸)
                if command -v curl >/dev/null 2>&1; then
                  if curl -f -s http://localhost/health >/dev/null 2>&1 || curl -f -s http://localhost >/dev/null 2>&1; then
                    echo "âœ… HTTP í—¬ìŠ¤ì²´í¬ë„ ì„±ê³µí–ˆìŠµë‹ˆë‹¤."
                  else
                    echo "âš ï¸ HTTP í—¬ìŠ¤ì²´í¬ëŠ” ì‹¤íŒ¨í–ˆì§€ë§Œ ì»¨í…Œì´ë„ˆëŠ” ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                  fi
                fi
                break
              fi
              
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„: $attempt/$max_attempts)"
              sleep 15
              ((attempt++))
              
              if [ $attempt -gt $max_attempts ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
                echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
                docker compose ps
                echo "ğŸ“‹ ë¡œê·¸ í™•ì¸:"
                docker compose logs --tail=50
                exit 1
              fi
            done

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f || echo "ì´ë¯¸ì§€ ì •ë¦¬ ìƒëµ"

            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“Š ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ:"
            docker compose ps

      - name: ğŸ”„ ë¡¤ë°± (ë°°í¬ ì‹¤íŒ¨ ì‹œ)
        if: failure() && steps.deploy.conclusion == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸ”„ ë¡¤ë°± í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
            cd /home/${{ secrets.SSH_USERNAME }}/epilog-deploy

            # í˜„ì¬ ì„œë¹„ìŠ¤ ì¤‘ì§€
            docker compose down --remove-orphans

            # ì´ì „ ë°±ì—… ì°¾ê¸°
            latest_backup=$(ls -t backups/services_backup_*.txt 2>/dev/null | head -1)
            if [ -n "$latest_backup" ]; then
              echo "ğŸ“‹ ì´ì „ ë°±ì—… ë°œê²¬: $latest_backup"
            fi

            # Gitì„ ì‚¬ìš©í•œ ë¡¤ë°± (ì´ì „ ì»¤ë°‹ìœ¼ë¡œ)
            if [ -d ".git" ]; then
              echo "ğŸ“¦ Git ê¸°ë°˜ ë¡¤ë°± ì‹œë„ ì¤‘..."
              git reset --hard HEAD~1 || echo "Git ë¡¤ë°± ì‹¤íŒ¨"
            fi

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸš€ ì´ì „ ë²„ì „ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            docker compose up -d

            # ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
            sleep 20
            if docker compose ps | grep -q "Up"; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ"
            else
              echo "âŒ ë¡¤ë°±ë„ ì‹¤íŒ¨"
              docker compose logs --tail=30
            fi

      - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          custom_payload: |
            {
              text: "${{ job.status == 'success' && 'âœ… TeamE ë°°í¬ ì„±ê³µ!' || 'âŒ TeamE ë°°í¬ ì‹¤íŒ¨!' }}",
              attachments: [{
                color: "${{ job.status == 'success' && 'good' || 'danger' }}",
                fields: [{
                  title: "í™˜ê²½",
                  value: "${{ github.event.inputs.environment || 'production' }}",
                  short: true
                }, {
                  title: "ë¸Œëœì¹˜",
                  value: "${{ github.ref_name }}",
                  short: true
                }, {
                  title: "ì»¤ë°‹",
                  value: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                  short: true
                }, {
                  title: "ì†Œìš” ì‹œê°„",
                  value: "${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
                  short: true
                }, {
                  title: "Action ë§í¬",
                  value: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì›Œí¬í”Œë¡œìš° ë³´ê¸°>",
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ§¹ ë°°í¬ íŒŒì¼ ì •ë¦¬ (ì„ íƒì‚¬í•­)
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸ§¹ ë°°í¬ íŒŒì¼ ì •ë¦¬ ì¤‘..."
            cd /home/${{ secrets.SSH_USERNAME }}/epilog-deploy

            # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (30ì¼ ì´ìƒ)
            find backups/ -name "*.txt" -type f -mtime +30 -delete 2>/dev/null || echo "ì •ë¦¬í•  ë°±ì—… íŒŒì¼ ì—†ìŒ"

            echo "âœ… ì •ë¦¬ ì™„ë£Œ"
