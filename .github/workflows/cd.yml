name: TeamE CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        default: "production"
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: ğŸš€ ì„œë¹„ìŠ¤ ë°°í¬
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: ğŸ“… ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¢ ë°°í¬ ì‹œì‘ ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "ğŸš€ TeamE ë°°í¬ ì‹œì‘",
              attachments: [{
                color: "warning",
                fields: [{
                  title: "í™˜ê²½",
                  value: "${{ github.event.inputs.environment || 'production' }}",
                  short: true
                }, {
                  title: "ë¸Œëœì¹˜",
                  value: "${{ github.ref_name }}",
                  short: true
                }, {
                  title: "ì»¤ë°",
                  value: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                  short: true
                }, {
                  title: "ì‹¤í–‰ì",
                  value: "${{ github.actor }}",
                  short: true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ” ë°°í¬ ì „ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ íŒŒì¼ ê²€ì¦ ì¤‘..."
          if [ ! -f "docker-compose.yml" ]; then
            echo "âŒ docker-compose.yml íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… docker-compose.yml íŒŒì¼ í™•ì¸ë¨"

          if ! grep -q "services:" docker-compose.yml; then
            echo "âŒ docker-compose.yml íŒŒì¼ì´ ìœ íšŒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… docker-compose.yml íŒŒì¼ ìœ íšŒì„± ê²€ì‚¬ ì™„ë£Œ"

      - name: ğŸš¤ ì„œë²„ ë°°í¬ ì‹¤í–‰
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          command_timeout: 30m
          script: |
            echo "ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
            cd /home/${{ secrets.SSH_USERNAME }}/backend/backend_django

            echo "ğŸ“‚ í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—… ì¤‘..."
            mkdir -p backups
            docker compose -f docker-compose.prod.yml --env-file .env.prod ps > backups/services_backup_$(date +%Y%m%d_%H%M%S).txt || echo "ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—… ì‚¬ì§"

            echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod down --remove-orphans

            echo "ğŸ“¥ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod pull

            echo "ğŸš€ ìƒˆ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

            echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
            sleep 30

            echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod ps

            echo "ğŸª© ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f || echo "ì´ë¯¸ì§€ ì •ë¦¬ ì‚¬ì§"

            echo "ğŸ‰ ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“Š ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ:"
            docker compose -f docker-compose.prod.yml --env-file .env.prod ps

      - name: ğŸ”„ ë¡¤ë°± (ë°°í¬ ì‹¤íŒ¨ ì‹œ)
        if: failure() && steps.deploy.conclusion == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            echo "ğŸ”„ ë¡¤ë°± í”„ë¡œì„¸ìŠ¤ ì‹œì‘..."
            cd /home/${{ secrets.SSH_USERNAME }}/backend/backend_django

            docker compose -f docker-compose.prod.yml --env-file .env.prod down --remove-orphans

            latest_backup=$(ls -t backups/services_backup_*.txt 2>/dev/null | head -1)
            if [ -n "$latest_backup" ]; then
              echo "ğŸ“‹ ì´ì „ ë°±ì—… ë°œê²¬: $latest_backup"
            fi

            if [ -d ".git" ]; then
              echo "ğŸ“† Git ê¸°ë°˜ ë¡¤ë°± ì‹œë„ ì¤‘..."
              git reset --hard HEAD~1 || echo "Git ë¡¤ë°± ì‹¤íŒ¨"
            fi

            echo "ğŸš€ ì´ì „ ë²„ì „ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

            sleep 20
            if docker compose ps | grep -q "Up"; then
              echo "âœ… ë¡¤ë°± ì„±ê³µ"
            else
              echo "âŒ ë¡¤ë°±ë„ ì‹¤íŒ¨"
              docker compose logs --tail=30
            fi

      - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          custom_payload: |
            {
              text: "${{ job.status == 'success' && 'âœ… TeamE ë°°í¬ ì„±ê³µ!' || 'âŒ TeamE ë°°í¬ ì‹¤íŒ¨!' }}",
              attachments: [{
                color: "${{ job.status == 'success' && 'good' || 'danger' }}",
                fields: [{
                  title: "í™˜ê²½",
                  value: "${{ github.event.inputs.environment || 'production' }}",
                  short: true
                }, {
                  title: "ë¸Œëœì¹˜",
                  value: "${{ github.ref_name }}",
                  short: true
                }, {
                  title: "ì»¤ë°",
                  value: "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                  short: true
                }, {
                  title: "ì†Œìš” ì‹œê°„",
                  value: "${{ job.status == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}",
                  short: true
                }, {
                  title: "Action ë§í¬",
                  value: "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì›Œí¬í”Œë¡œìš° ë³´ê¸°>",
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
